{% extends 'base.html' %}

{% block title %}طلبات الأقسام الخاصة بي{% endblock %}

{% block extra_head %}
  <!-- Optimized Assets -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #001f3f, #003366, #004080);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.18);
    }

    body {
      background: var(--primary-gradient);
      color: #fefefe;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      position: relative;
    }

    /* Parallax Background Layers */
    body::before,
    body::after {
      content: '';
      position: fixed;
      width: 150vw;
      height: 150vh;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1) 0%, transparent 60%);
      transform: translate(-50%, -50%);
      z-index: -1;
      animation: float 20s infinite linear;
    }

    body::after {
      animation-delay: -10s;
      opacity: 0.5;
    }

    @keyframes float {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px) saturate(180%);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);
      border: 1px solid var(--glass-border);
      padding: 30px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      pointer-events: none;
      transition: 0.5s;
    }

    .glass-card:hover::before {
      animation: glassGlow 3s linear infinite;
    }

    @keyframes glassGlow {
      0% { transform: rotate(45deg) translate(-50%, -50%); }
      100% { transform: rotate(45deg) translate(50%, 50%); }
    }

    /* Enhanced Filter Buttons */
    .filter-btns .btn {
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-width: 2px;
      backdrop-filter: blur(8px);
    }

    .filter-btns .btn.active {
      background: rgba(255,255,255,0.9) !important;
      color: #004080 !important;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    /* Modern Table Design */
    .table-hover tbody tr {
      transition: all 0.3s ease;
      position: relative;
    }

    .table-hover tbody tr:hover {
      background: rgba(255,255,255,0.08) !important;
    }

    .table-hover tbody tr::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 95%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transform: translateX(-50%);
    }

    /* Responsive Cards for Mobile */
    @media (max-width: 768px) {
      .table-responsive {
        display: none;
      }

      .mobile-cards {
        display: block;
      }

      .request-card {
        background: rgba(255,255,255,0.05);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        backdrop-filter: blur(8px);
        transition: transform 0.3s ease;
      }

      .request-card:hover {
        transform: translateY(-3px);
      }
    }

    /* Enhanced Badges */
    .badge {
      position: relative;
      overflow: hidden;
      font-weight: 500;
      letter-spacing: 0.5px;
      padding: 8px 16px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .badge:hover::before {
      opacity: 1;
    }

    /* Animated Empty State */
    .empty-state {
      animation: floatUp 1s ease;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    @keyframes floatUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Scroll Progress Indicator */
    .scroll-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #00b4d8, #0077b6);
      z-index: 9999;
      transition: width 0.3s ease-out;
    }
  </style>
{% endblock %}

{% block content %}
<div class="scroll-progress" id="scrollProgress"></div>

<div class="container my-5" dir="rtl">
  <div class="text-center mb-5">
    <h1 class="fw-bold display-5 mb-3">
      <i class="fas fa-clipboard-list me-2"></i>طلبات الخدمات الموجهة لي
    </h1>
    <p class="fs-5 text-dark opacity-85">
      <i class="fas fa-lightbulb me-2"></i>إدارة الطلبات الواردة للقسم الخدمي الخاص بك
    </p>
  </div>

  <div class="mb-4 text-center filter-btns">
    {% for option in filter_options %}
      <a href="?filter={{ option.key }}{% if assigned_user_id %}&assigned_to={{ assigned_user_id }}{% endif %}" 
         class="btn btn-outline-dark rounded-pill px-4 m-2 {% if filter == option.key %}active{% endif %}"
         aria-current="{% if filter == option.key %}page{% else %}false{% endif %}">
        <i class="fas fa-{{ option.icon }} me-2"></i>
        {{ option.label }}
      </a>
    {% endfor %}
  </div>

  <div class="btn btn-dark rounded-pill px-4 m-2">
    <form method="get" class="d-flex flex-wrap align-items-center gap-2 glass-card px-3 py-2">
      <input type="hidden" name="filter" value="{{ filter|default:'all' }}">
      <label for="assignedFilter" class="mb-0 fw-semibold text-uppercase small text-light">
        <i class="fas fa-user-filter me-2"></i>تصفية حسب المسؤول
      </label>
      <select id="assignedFilter" name="assigned_to" style="border-radius:20px;" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
        <option value="" {% if not assigned_user_id %}selected{% endif %}>كل المسؤولين</option>
        <option value="unassigned" {% if assigned_user_id == 'unassigned' %}selected{% endif %}>غير معيّن</option>
        {% for user in assigned_users %}
          <option value="{{ user.id }}" {% if assigned_user_id == user.id|stringformat:'s' %}selected{% endif %}>
            {{ user.get_full_name|default:user.username }}
          </option>
        {% endfor %}
      </select>
    </form>
    {% if assigned_user_id %}
      <a href="?filter={{ filter|default:'all' }}" class="btn btn-link text-light text-decoration-none">
        <i class="fas fa-times me-1"></i>إزالة التصفية
      </a>
    {% endif %}
  </div>

  <div class="glass-card">
    <div class="d-flex align-items-center mb-4">
      <h2 class="h3 mb-0">
        <i class="fas fa-scroll me-3"></i>قائمة الطلبات
      </h2>
      <span class="badge bg-light text-dark ms-auto">
        العدد الإجمالي: {{ service_requests.count }}
      </span>
    </div>

    {% if service_requests %}
      <div class="table-responsive d-none d-md-block">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>العنوان</th>
              <th>الوصف</th>
              <th>القسم</th>
              <th>الحالة</th>
              <th>المسؤول</th>
              <th>التاريخ</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for request in service_requests %}
              <tr onclick="window.location.href='{% url 'request_detail' request.id %}'" style="cursor: pointer;">
              <td class="fw-bold text-info">#{{ request.id }}</td>
              <td class="text-nowrap">{{ request.title }}</td>
              <td class="text-truncate" style="max-width: 250px;" title="{{ request.description }}">
                {{ request.description }}
              </td>
              <td>{{ request.section.name }}</td>
              <td>
                {% if request.status == 'pending' %}
                  <span class="badge bg-warning"><i class="fas fa-hourglass-half"></i> قيد الانتظار</span>
                {% elif request.status == 'in_progress' %}
                  <span class="badge bg-info text-dark"><i class="fas fa-spinner"></i> قيد التنفيذ</span>
                {% elif request.status == 'completed' %}
                  <span class="badge bg-success"><i class="fas fa-check-circle"></i> مكتمل</span>
                {% elif request.status == 'under_review' %}
                  <span class="badge bg-primary"><i class="fas fa-eye"></i> قيد المراجعة</span>
                {% else %}
                  <span class="badge bg-light text-dark">{{ request.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if request.assigned_to %}
                  {{ request.assigned_to.get_full_name|default:request.assigned_to.username }}
                {% else %}
                  غير معيّن
                {% endif %}
              </td>
              <td class="text-nowrap">{{ request.created_at|date:"Y-m-d H:i" }}</td>
              <td>
                <!-- Button that doesn't trigger the row click -->
                <a href="{% url 'print_request' request.id %}" class="btn btn-sm btn-outline-primary"
                   onclick="event.stopPropagation();">
                  <i class="fas fa-print me-1" aria-hidden="true" style="font-size: 0.9rem;"></i>
                   طباعة
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile Cards -->
      <div class="mobile-cards d-md-none">
        {% for request in service_requests %}
          <div class="request-card" onclick="window.location.href='{% url 'request_detail' request.id %}'">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-info fw-bold">#{{ request.id }}</span>
              {% if request.status == 'pending' %}
                <span class="badge bg-warning"><i class="fas fa-hourglass-half"></i> قيد الانتظار</span>
              {% elif request.status == 'in_progress' %}
                <span class="badge bg-info text-dark"><i class="fas fa-spinner"></i> قيد التنفيذ</span>
              {% elif request.status == 'completed' %}
                <span class="badge bg-success"><i class="fas fa-check-circle"></i> مكتمل</span>
              {% elif request.status == 'under_review' %}
                <span class="badge bg-primary"><i class="fas fa-eye"></i> قيد المراجعة</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ request.status }}</span>
              {% endif %}
            </div>
            <h6 class="mb-2">{{ request.title }}</h6>
            <p class="text-muted small mb-2">{{ request.description|truncatechars:60 }}</p>
            <div class="d-flex justify-content-between text-muted small">
              <span>{{ request.section.name }}</span>
              <span>
                {% if request.assigned_to %}
                  {{ request.assigned_to.get_full_name|default:request.assigned_to.username }}
                {% else %}
                  غير معيّن
                {% endif %}
              </span>
            </div>
            <div class="text-muted small mt-2">{{ request.created_at|date:"Y-m-d H:i" }}</div>
          </div>
          <hr>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state text-center py-5">
        <div class="mb-4">
          <svg class="animate__animated animate__pulse" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.25 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
        </div>
        <h4 class="mb-3">لا توجد طلبات متاحة</h4>
        <p class="text-muted">يمكنك التحقق مرة أخرى لاحقًا أو إنشاء طلب جديد</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Scroll Progress Indicator
  window.addEventListener('scroll', () => {
    const scrollProgress = document.getElementById('scrollProgress');
    const windowHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (window.scrollY / windowHeight) * 100;
    scrollProgress.style.width = scrolled + '%';
  });

  // Smooth Table Row Hover
  document.querySelectorAll('tr[onclick]').forEach(row => {
    row.addEventListener('mouseenter', () => {
      row.style.transform = 'scale(1.01)';
      row.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
    });
    
    row.addEventListener('mouseleave', () => {
      row.style.transform = 'scale(1)';
      row.style.boxShadow = 'none';
    });
  });
</script>
{% endblock %}
